<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/BatchFactory.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> BatchFactory.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.43% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>64/70</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.36% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>57/66</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>18/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.26% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>83/89</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">111×</span>
<span class="cline-any cline-yes">110×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">38×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">85×</span>
<span class="cline-any cline-yes">84×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-yes">80×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">78×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-yes">75×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">75×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">111×</span>
<span class="cline-any cline-yes">110×</span>
<span class="cline-any cline-yes">110×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">70×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">70×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">70×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">70×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">38×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/proxy/Clones.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/cryptography/ECDSA.sol";
import "./BatchManager.sol";
import "./Once721TemplateV2.sol";
import "./Once1155TemplateV2.sol";
&nbsp;
/**
 * @title BatchFactory
 * @dev Factory contract for creating batches and deploying NFT contracts using EIP-1167 minimal proxy
 */
contract BatchFactory is AccessControl, ReentrancyGuard {
    using SafeERC20 for IERC20;
    
    bytes32 public constant SYSTEM_ADMIN_ROLE = keccak256("SYSTEM_ADMIN_ROLE");
    
    // Template contracts for cloning
    address public immutable once721Template;
    address public immutable once1155Template;
    
    // BatchManager contract
    BatchManager public immutable batchManager;
    
    // Configuration
    uint256 public tokensPerCode = 1; // System-wide ERC20 cost per code for batch creation
    uint256 public minCodesPerBatch = 10;
    
    // Payment token for batch creation fees
    address public paymentToken; // ERC20 token address for payment
    
    // NFT Type enum
    enum NFTType { ERC721, ERC1155_ART, ERC1155_STAMP }
    
    // Structs
    struct CreateBatchParams {
        NFTType nftType;
        string name;
        string symbol;
        bytes32 merkleRoot;
        uint256 totalCodes;
        uint256 expireTime;
        address existingNFTContract; // Optional: use existing NFT contract
        address royaltyRecipient;
        uint96 royaltyFeeNumerator; // In basis points (100 = 1%)
        string baseURI;
        uint256 deadline; // For backend signature
        bytes backendSig; // Backend signature
    }
    
    // State variables
    mapping(address =&gt; address[]) public issuerNFTContracts;
    mapping(address =&gt; mapping(NFTType =&gt; address[])) public issuerNFTContractsByType;
    mapping(address =&gt; uint256) public issuerNonce; // Track nonce for each issuer
    
    // TrustedSigner variables
    mapping(address =&gt; bool) public trustedSigners;
    mapping(bytes32 =&gt; bool) public usedSignatures;
    
    // Events
    event NFTContractDeployed(
        address indexed issuer,
        address indexed nftContract,
        NFTType indexed nftType,
        string name,
        string symbol
    );
    
    event BatchCreatedViaFactory(
        uint256 indexed batchId,
        address indexed issuer,
        address indexed nftContract,
        NFTType nftType,
        bytes32 merkleRoot,
        uint256 tokensPerCode,
        uint256 totalCodes
    );
    
    event PaymentCollected(
        address indexed issuer,
        uint256 indexed batchId,
        uint256 totalPayment
    );
    
    event SignatureVerified(address indexed issuer, address indexed signer);
&nbsp;
    constructor(
        address _batchManager,
        address _once721Template,
        address _once1155Template,
        address _paymentToken
    ) {
        require(_batchManager != address(0), "Invalid BatchManager address");
        require(_once721Template != address(0), "Invalid ERC721 template address");
        require(_once1155Template != address(0), "Invalid ERC1155 template address");
        require(_paymentToken != address(0), "Invalid payment token address");
        
        batchManager = BatchManager(_batchManager);
        once721Template = _once721Template;
        once1155Template = _once1155Template;
        paymentToken = _paymentToken;
        
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(SYSTEM_ADMIN_ROLE, msg.sender);
    }
&nbsp;
    // Configuration functions
    function setTokensPerCode(uint256 _tokensPerCode) external onlyRole(SYSTEM_ADMIN_ROLE) {
        tokensPerCode = _tokensPerCode; // System Admin sets universal rate (0 = free)
    }
&nbsp;
    function setMinCodesPerBatch(uint256 _minCodes) external onlyRole(SYSTEM_ADMIN_ROLE) {
        require(_minCodes &gt; 0, "Min codes must be positive");
        minCodesPerBatch = _minCodes;
    }
&nbsp;
    function setPaymentToken(address _paymentToken) external onlyRole(SYSTEM_ADMIN_ROLE) {
        require(_paymentToken != address(0), "Invalid payment token address");
        paymentToken = _paymentToken;
    }
&nbsp;
    // Main function to create batch
    // TrustSigner flow: verify backend signature for batch creation
    function createBatch(CreateBatchParams memory params) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant returns (uint256 batchId, address nftContract) {
        // Validate parameters
        require(params.merkleRoot != bytes32(0), "Invalid merkle root");
        require(params.totalCodes &gt;= minCodesPerBatch, "Total codes below minimum");
&nbsp;
        address issuer = msg.sender;
        uint256 nonce = issuerNonce[issuer];
&nbsp;
        // TrustSigner: verify backend signature for batch creation
        address backendSigner = _verifyBackendSignature(
            issuer,
            params.nftType,
            params.name,
            params.symbol,
            params.merkleRoot,
            params.totalCodes,
            params.expireTime,
            params.royaltyRecipient,
            params.royaltyFeeNumerator,
            params.baseURI,
            params.deadline,
            nonce,
            params.backendSig
        );
&nbsp;
        emit SignatureVerified(issuer, backendSigner);
&nbsp;
        // Calculate and collect payment using system-defined rate
        uint256 totalPayment = tokensPerCode * params.totalCodes;
        if (totalPayment &gt; 0) {
            IERC20(paymentToken).safeTransferFrom(issuer, address(this), totalPayment);
        }
&nbsp;
        // Determine NFT contract to use
        if (params.existingNFTContract != address(0)) {
            // Use existing NFT contract
            nftContract = params.existingNFTContract;
            require(_isValidNFTContract(nftContract, params.nftType), "Invalid existing NFT contract");
        } else {
            // Deploy new NFT contract - validate royalty parameters only when creating new contract
            require(params.royaltyRecipient != address(0), "Invalid royalty recipient");
            require(params.royaltyFeeNumerator &lt;= 10000, "Royalty fee too high"); // Max 100%
            
            nftContract = _deployNFTContract(
                issuer,
                params.nftType,
                params.name,
                params.symbol,
                params.royaltyRecipient,
                params.royaltyFeeNumerator,
                params.baseURI
            );
        }
&nbsp;
        // Create batch in BatchManager (payment handled at factory level)
        batchId = batchManager.createBatch(
            issuer,
            nftContract,
            params.merkleRoot,
            params.totalCodes,
            params.expireTime,
            params.nftType == NFTType.ERC721
        );
&nbsp;
        issuerNonce[issuer]++;
&nbsp;
        emit BatchCreatedViaFactory(
            batchId,
            issuer,
            nftContract,
            params.nftType,
            params.merkleRoot,
            tokensPerCode, // Payment amount per code (system rate)
            params.totalCodes
        );
&nbsp;
        if (totalPayment &gt; 0) {
            emit PaymentCollected(issuer, batchId, totalPayment);
        }
&nbsp;
        return (batchId, nftContract);
    }
&nbsp;
    // Events for TrustedSigner
    event TrustedSignerAdded(address indexed signer);
    event TrustedSignerRemoved(address indexed signer);
    
    // Internal function for backend signature verification
    function _verifyBackendSignature(
        address issuer,
        NFTType nftType,
        string memory name,
        string memory symbol,
        bytes32 merkleRoot,
        uint256 totalCodes,
        uint256 expireTime,
        address royaltyRecipient,
        uint96 royaltyFeeNumerator,
        string memory baseURI,
        uint256 deadline,
        uint256 nonce,
        bytes memory signature
    ) internal returns (address signer) {
        require(block.timestamp &lt;= deadline, "Signature expired");
        
        // Create the message hash according to the specified format
        bytes32 messageHash = keccak256(abi.encodePacked(
            issuer,
            nftType,
            name,
            symbol,
            merkleRoot,
            totalCodes,
            expireTime,
            royaltyRecipient,
            royaltyFeeNumerator,
            baseURI,
            deadline,
            nonce
        ));
        
        // Create Ethereum signed message hash
        bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
            "\x19Ethereum Signed Message:\n32",
            messageHash
        ));
        
        // Prevent signature replay
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!usedSignatures[ethSignedMessageHash], "Signature already used");
        usedSignatures[ethSignedMessageHash] = true;
        
        // Recover signer
        signer = ECDSA.recover(ethSignedMessageHash, signature);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(trustedSigners[signer], "Invalid signer");
        
        return signer;
    }
&nbsp;
    function addTrustedSigner(address signer) external onlyRole(SYSTEM_ADMIN_ROLE) {
        require(signer != address(0), "Invalid signer address");
        require(!trustedSigners[signer], "Signer already exists");
        trustedSigners[signer] = true;
        emit TrustedSignerAdded(signer);
    }
&nbsp;
    function removeTrustedSigner(address signer) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(SYSTEM_ADMIN_ROLE) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(trustedSigners[signer], "Signer does not exist");
        trustedSigners[signer] = false;
        emit TrustedSignerRemoved(signer);
    }
&nbsp;
    function isTrustedSigner(address signer) public view returns (bool) {
        return trustedSigners[signer];
    }
&nbsp;
&nbsp;
&nbsp;
    // Deploy new NFT contract using EIP-1167 minimal proxy
    function _deployNFTContract(
        address issuer,
        NFTType nftType,
        string memory name,
        string memory symbol,
        address royaltyRecipient,
        uint96 royaltyFeeNumerator,
        string memory baseURI
    ) internal returns (address) {
        address implementation;
        address clone;
        
        // Use issuer nonce instead of timestamp for deterministic salt
        uint256 currentNonce = issuerNonce[issuer];
        bytes32 salt = keccak256(abi.encodePacked(issuer, name, symbol, currentNonce));
        
        if (nftType == NFTType.ERC721) {
            implementation = once721Template;
            // Use CREATE2 for deterministic address
            clone = Clones.cloneDeterministic(implementation, salt);
            
            // Initialize the cloned contract
            Once721TemplateV2(clone).initialize(
                name,
                symbol,
                issuer, // owner
                address(batchManager), // minter
                royaltyRecipient,
                royaltyFeeNumerator
            );
            
            // Set base URI if provided
            <span class="missing-if-branch" title="if path not taken" >I</span>if (bytes(baseURI).length &gt; 0) {
<span class="cstat-no" title="statement not covered" >                Once721TemplateV2(clone).setBaseURI(baseURI)</span>;
            }
            
        } else {
            // ERC1155 for both ART and STAMP types
            implementation = once1155Template;
            // Use CREATE2 for deterministic address
            clone = Clones.cloneDeterministic(implementation, salt);
            
            // Initialize the cloned contract
            Once1155TemplateV2(clone).initialize(
                name,
                symbol,
                issuer, // owner
                address(batchManager), // minter
                royaltyRecipient,
                royaltyFeeNumerator
            );
            
            // Set base URI if provided
            <span class="missing-if-branch" title="if path not taken" >I</span>if (bytes(baseURI).length &gt; 0) {
<span class="cstat-no" title="statement not covered" >                Once1155TemplateV2(clone).setURI(baseURI)</span>;
            }
        }
        
        // Track the contract
        issuerNFTContracts[issuer].push(clone);
        issuerNFTContractsByType[issuer][nftType].push(clone);
        
        emit NFTContractDeployed(issuer, clone, nftType, name, symbol);
        
        return clone;
    }
&nbsp;
    // Validate existing NFT contract
    function _isValidNFTContract(address nftContract, NFTType nftType) internal view returns (bool) {
        <span class="missing-if-branch" title="else path not taken" >E</span>if (nftType == NFTType.ERC721) {
            // Check if it's an ERC721 contract and has MINTER_ROLE for batchManager
            try Once721TemplateV2(nftContract).hasRole(
                Once721TemplateV2(nftContract).MINTER_ROLE(),
                address(batchManager)
            ) returns (bool hasMinterRole) {
                return hasMinterRole;
            } catch {
<span class="cstat-no" title="statement not covered" >                return false;</span>
            }
        } else {
            // Check if it's an ERC1155 contract and has MINTER_ROLE for batchManager
<span class="cstat-no" title="statement not covered" >            try Once1155TemplateV2(nftContract).hasRole(</span>
                Once1155TemplateV2(nftContract).MINTER_ROLE(),
                address(batchManager)
            ) returns (bool hasMinterRole) {
<span class="cstat-no" title="statement not covered" >                return hasMinterRole;</span>
            } catch {
<span class="cstat-no" title="statement not covered" >                return false;</span>
            }
        }
    }
&nbsp;
    // View functions
    function calculateBatchCost(uint256 totalCodes) external view returns (uint256) {
        return tokensPerCode * totalCodes;
    }
&nbsp;
    function getIssuerNFTContracts(address issuer) external view returns (address[] memory) {
        return issuerNFTContracts[issuer];
    }
&nbsp;
    function getIssuerNFTContractsByType(address issuer, NFTType nftType) 
        external 
        view 
        returns (address[] memory) 
    {
        return issuerNFTContractsByType[issuer][nftType];
    }
&nbsp;
    // Get current nonce for an issuer (NFT deployment)
    function getIssuerNonce(address issuer) external view returns (uint256) {
        return issuerNonce[issuer];
    }
&nbsp;
    // Predict Next NFT contract address for an issuer based on current nonce
    function predictNextAddress(
        address issuer,
        NFTType nftType,
        string memory name,
        string memory symbol
    ) external view returns (address) {
        address implementation = nftType == NFTType.ERC721 ? once721Template : <span class="missing-if-branch" title="else path not taken" >E</span>once1155Template;
        uint256 nonce = issuerNonce[issuer];
        bytes32 salt = keccak256(abi.encodePacked(issuer, name, symbol, nonce));
        return Clones.predictDeterministicAddress(implementation, salt, address(this));
    }
&nbsp;
    // Payment management functions
    function withdrawPayments(address to, uint256 amount) external onlyRole(SYSTEM_ADMIN_ROLE) {
        require(to != address(0), "Invalid recipient address");
        IERC20(paymentToken).safeTransfer(to, amount);
    }
&nbsp;
    function getPaymentBalance() external view returns (uint256) {
        return IERC20(paymentToken).balanceOf(address(this));
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Sep 19 2025 21:43:27 GMT+0700 (Indochina Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
