<!DOCTYPE html>
<html>
<head>
    <title>Test Monad Transaction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #6d28d9;
        }
        button:disabled {
            background-color: #4a4a4a;
            cursor: not-allowed;
        }
        input {
            background-color: #3a3a3a;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background-color: #065f46;
            border: 1px solid #10b981;
        }
        .error {
            background-color: #7f1d1d;
            border: 1px solid #ef4444;
        }
        .info {
            background-color: #1e3a8a;
            border: 1px solid #3b82f6;
        }
        .warning {
            background-color: #92400e;
            border: 1px solid #f59e0b;
        }
        .hidden {
            display: none;
        }
        .transaction-form {
            background-color: #374151;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .balance-display {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
    </style>
</head>
<body>
    <h1>üî• Monad Transaction Test</h1>
    
    <div class="container">
        <h2>1. Network Setup</h2>
        <button onclick="addNetwork()">Add Monad Testnet</button>
        <button onclick="switchNetwork()">Switch to Monad Testnet</button>
        <div id="networkStatus"></div>
    </div>

    <div class="container">
        <h2>2. Wallet Connection</h2>
        <button onclick="connectWallet()">Connect MetaMask</button>
        <button onclick="checkConnection()">Check Connection</button>
        <div id="walletStatus"></div>
        <div id="accountInfo"></div>
    </div>

    <div class="container">
        <h2>3. Balance Check</h2>
        <button onclick="checkBalance()">Check MON Balance</button>
        <div id="balanceInfo"></div>
    </div>

    <div class="container">
        <h2>4. Send Test Transaction</h2>
        <div class="transaction-form">
            <div>
                <label>To Address:</label><br>
                <input type="text" id="toAddress" value="0x0000000000000000000000000000000000000000" placeholder="0x...">
            </div>
            <div>
                <label>Amount (MON):</label><br>
                <input type="number" id="amount" value="0.001" step="0.001" min="0">
            </div>
            <div>
                <button onclick="sendTransaction()" id="sendBtn">Send Transaction</button>
                <button onclick="estimateGas()" id="estimateBtn">Estimate Gas</button>
            </div>
        </div>
        <div id="transactionStatus"></div>
        <div id="gasEstimate"></div>
    </div>

    <div class="container">
        <h2>5. Transaction History</h2>
        <button onclick="clearHistory()">Clear History</button>
        <div id="transactionHistory"></div>
    </div>

    <script>
        let currentAccount = null;
        let web3 = null;

        // Network configuration
        const MONAD_TESTNET = {
            chainId: '0x279F', // 10143 in decimal
            chainName: 'Monad Testnet',
            nativeCurrency: {
                name: 'Monad',
                symbol: 'MON',
                decimals: 18,
            },
            rpcUrls: ['https://testnet-rpc.monad.xyz'],
            blockExplorerUrls: ['https://testnet.monadexplorer.com/'],
        };

        // Utility functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addToHistory(transaction) {
            const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            history.unshift({
                ...transaction,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('transactionHistory', JSON.stringify(history.slice(0, 10))); // Keep last 10
            displayHistory();
        }

        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const historyDiv = document.getElementById('transactionHistory');
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<p>No transactions yet</p>';
                return;
            }

            let html = '<h3>Recent Transactions:</h3>';
            history.forEach(tx => {
                const date = new Date(tx.timestamp).toLocaleString();
                const status = tx.success ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="transaction-form">
                        <strong>${status} ${date}</strong><br>
                        To: ${tx.to}<br>
                        Amount: ${tx.amount} MON<br>
                        ${tx.hash ? `Hash: <a href="https://testnet.monadexplorer.com/tx/${tx.hash}" target="_blank">${tx.hash.substring(0, 20)}...</a><br>` : ''}
                        ${tx.error ? `Error: ${tx.error}<br>` : ''}
                    </div>
                `;
            });
            historyDiv.innerHTML = html;
        }

        function clearHistory() {
            localStorage.removeItem('transactionHistory');
            displayHistory();
            showStatus('transactionHistory', 'Transaction history cleared', 'info');
        }

        // Network functions
        async function addNetwork() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [MONAD_TESTNET],
                    });
                    showStatus('networkStatus', '‚úÖ Monad testnet added successfully!', 'success');
                } catch (error) {
                    console.error('Error adding network:', error);
                    showStatus('networkStatus', `‚ùå Error adding network: ${error.message}`, 'error');
                }
            } else {
                showStatus('networkStatus', '‚ùå MetaMask not found!', 'error');
            }
        }

        async function switchNetwork() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: MONAD_TESTNET.chainId }],
                    });
                    showStatus('networkStatus', '‚úÖ Switched to Monad testnet!', 'success');
                    await checkConnection(); // Refresh connection info
                } catch (error) {
                    if (error.code === 4902) {
                        showStatus('networkStatus', '‚ö†Ô∏è Network not found, trying to add it...', 'warning');
                        await addNetwork();
                    } else {
                        console.error('Error switching network:', error);
                        showStatus('networkStatus', `‚ùå Error switching network: ${error.message}`, 'error');
                    }
                }
            } else {
                showStatus('networkStatus', '‚ùå MetaMask not found!', 'error');
            }
        }

        // Wallet functions
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    currentAccount = accounts[0];
                    showStatus('walletStatus', '‚úÖ Wallet connected successfully!', 'success');
                    await checkConnection();
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    showStatus('walletStatus', `‚ùå Error connecting wallet: ${error.message}`, 'error');
                }
            } else {
                showStatus('walletStatus', '‚ùå MetaMask not found! Please install MetaMask.', 'error');
            }
        }

        async function checkConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        const chainIdDecimal = parseInt(chainId, 16);
                        const isMonadNetwork = chainId === MONAD_TESTNET.chainId;
                        
                        document.getElementById('accountInfo').innerHTML = `
                            <div class="status ${isMonadNetwork ? 'success' : 'warning'}">
                                <strong>Account:</strong> ${currentAccount}<br>
                                <strong>Chain ID:</strong> ${chainIdDecimal} (${chainId})<br>
                                <strong>Network:</strong> ${isMonadNetwork ? '‚úÖ Monad Testnet' : '‚ö†Ô∏è Wrong Network'}
                            </div>
                        `;
                        
                        if (isMonadNetwork) {
                            await checkBalance();
                        }
                    } else {
                        currentAccount = null;
                        document.getElementById('accountInfo').innerHTML = '<div class="status warning">‚ö†Ô∏è No wallet connected</div>';
                    }
                } catch (error) {
                    console.error('Error checking connection:', error);
                    showStatus('walletStatus', `‚ùå Error checking connection: ${error.message}`, 'error');
                }
            }
        }

        // Balance functions
        async function checkBalance() {
            if (!currentAccount) {
                showStatus('balanceInfo', '‚ö†Ô∏è Please connect wallet first', 'warning');
                return;
            }

            try {
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [currentAccount, 'latest'],
                });
                
                const balanceInMON = parseInt(balance, 16) / Math.pow(10, 18);
                
                document.getElementById('balanceInfo').innerHTML = `
                    <div class="status success">
                        <div class="balance-display">üí∞ ${balanceInMON.toFixed(6)} MON</div>
                        <small>Raw balance: ${balance}</small>
                    </div>
                `;
                
                // Enable/disable send button based on balance
                const sendBtn = document.getElementById('sendBtn');
                if (balanceInMON <= 0) {
                    sendBtn.disabled = true;
                    showStatus('balanceInfo', '‚ö†Ô∏è No MON balance! Visit https://testnet.monad.xyz to get test tokens.', 'warning');
                } else {
                    sendBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Error checking balance:', error);
                showStatus('balanceInfo', `‚ùå Error checking balance: ${error.message}`, 'error');
            }
        }

        // Transaction functions
        async function estimateGas() {
            const toAddress = document.getElementById('toAddress').value;
            const amount = document.getElementById('amount').value;
            
            if (!currentAccount) {
                showStatus('gasEstimate', '‚ö†Ô∏è Please connect wallet first', 'warning');
                return;
            }

            if (!toAddress || !amount) {
                showStatus('gasEstimate', '‚ö†Ô∏è Please fill in all fields', 'warning');
                return;
            }

            try {
                const amountWei = '0x' + (parseFloat(amount) * Math.pow(10, 18)).toString(16);
                
                const gasEstimate = await window.ethereum.request({
                    method: 'eth_estimateGas',
                    params: [{
                        from: currentAccount,
                        to: toAddress,
                        value: amountWei,
                    }],
                });
                
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice',
                    params: [],
                });
                
                const gasCost = (parseInt(gasEstimate, 16) * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                
                showStatus('gasEstimate', 
                    `‚õΩ Gas Estimate: ${parseInt(gasEstimate, 16)} units<br>
                     Gas Price: ${parseInt(gasPrice, 16)} wei<br>
                     Total Gas Cost: ${gasCost.toFixed(8)} MON`, 
                    'info'
                );
                
            } catch (error) {
                console.error('Error estimating gas:', error);
                showStatus('gasEstimate', `‚ùå Error estimating gas: ${error.message}`, 'error');
            }
        }

        async function sendTransaction() {
            const toAddress = document.getElementById('toAddress').value;
            const amount = document.getElementById('amount').value;
            
            if (!currentAccount) {
                showStatus('transactionStatus', '‚ö†Ô∏è Please connect wallet first', 'warning');
                return;
            }

            if (!toAddress || !amount) {
                showStatus('transactionStatus', '‚ö†Ô∏è Please fill in all fields', 'warning');
                return;
            }

            // Disable button during transaction
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                const amountWei = '0x' + (parseFloat(amount) * Math.pow(10, 18)).toString(16);
                
                showStatus('transactionStatus', 'üì§ Sending transaction...', 'info');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: currentAccount,
                        to: toAddress,
                        value: amountWei,
                    }],
                });
                
                showStatus('transactionStatus', 
                    `‚úÖ Transaction sent successfully!<br>
                     Hash: <a href="https://testnet.monadexplorer.com/tx/${txHash}" target="_blank">${txHash}</a><br>
                     ‚è≥ Waiting for confirmation...`, 
                    'success'
                );
                
                // Add to history
                addToHistory({
                    to: toAddress,
                    amount: amount,
                    hash: txHash,
                    success: true
                });
                
                // Wait for transaction receipt
                checkTransactionStatus(txHash);
                
            } catch (error) {
                console.error('Error sending transaction:', error);
                showStatus('transactionStatus', `‚ùå Error sending transaction: ${error.message}`, 'error');
                
                // Add failed transaction to history
                addToHistory({
                    to: toAddress,
                    amount: amount,
                    success: false,
                    error: error.message
                });
            } finally {
                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Transaction';
                
                // Refresh balance
                setTimeout(checkBalance, 2000);
            }
        }

        async function checkTransactionStatus(txHash) {
            let attempts = 0;
            const maxAttempts = 30; // 30 attempts = ~5 minutes
            
            const checkStatus = async () => {
                try {
                    const receipt = await window.ethereum.request({
                        method: 'eth_getTransactionReceipt',
                        params: [txHash],
                    });
                    
                    if (receipt) {
                        const status = receipt.status === '0x1' ? 'Success' : 'Failed';
                        const statusClass = receipt.status === '0x1' ? 'success' : 'error';
                        
                        showStatus('transactionStatus', 
                            `üéâ Transaction confirmed!<br>
                             Status: ${status}<br>
                             Block: ${parseInt(receipt.blockNumber, 16)}<br>
                             Gas Used: ${parseInt(receipt.gasUsed, 16)}<br>
                             Hash: <a href="https://testnet.monadexplorer.com/tx/${txHash}" target="_blank">${txHash}</a>`, 
                            statusClass
                        );
                        
                        return;
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 10000); // Check every 10 seconds
                    } else {
                        showStatus('transactionStatus', 
                            `‚è∞ Transaction confirmation timeout. Check manually:<br>
                             <a href="https://testnet.monadexplorer.com/tx/${txHash}" target="_blank">${txHash}</a>`, 
                            'warning'
                        );
                    }
                    
                } catch (error) {
                    console.error('Error checking transaction status:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 10000);
                    }
                }
            };
            
            setTimeout(checkStatus, 5000); // First check after 5 seconds
        }

        // Auto-check connection on load
        window.addEventListener('load', async () => {
            await checkConnection();
            displayHistory();
            
            // Listen for account changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', checkConnection);
                window.ethereum.on('chainChanged', checkConnection);
            }
        });
    </script>
</body>
</html>